---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import {
  getSimpleProjects,
  getSimpleProject,
  isContentfulConfigured,
  type ContentfulSimpleProject,
} from "../../../utils/contentful";

import { getLangFromUrl, useTranslations } from "../../../i18n/utils";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

export async function getStaticPaths() {
  let projects: {
    params: { slug: string };
    props: { project: ContentfulSimpleProject };
  }[] = [];

  try {
    if (isContentfulConfigured()) {
      const contentfulProjects = await getSimpleProjects(false, "id-ID"); // Fetch ID projects
      projects = contentfulProjects.map((project) => ({
        params: { slug: project.fields.slug },
        props: { project },
      }));
    }
  } catch (error) {
    console.warn("Error fetching projects:", error);
  }

  // Fallback if no projects
  if (projects.length === 0) {
    projects = [
      {
        params: { slug: "proyek-contoh" },
        props: {
          project: {
            sys: {
              id: "fallback",
              createdAt: "2024-01-01",
              updatedAt: "2024-01-01",
            },
            fields: {
              title: "Proyek Contoh",
              slug: "proyek-contoh",
              description: "Ini adalah deskripsi proyek contoh.",
              content:
                "## Tentang Proyek Ini\n\nIni adalah konten contoh untuk proyek.",
              category: "web",
              technologies: ["Astro", "TypeScript", "Tailwind CSS"],
              featured: true,
            },
          } as ContentfulSimpleProject,
        },
      },
    ];
  }

  return projects;
}

const { project } = Astro.props;

// Category colors
const categoryColors: Record<string, string> = {
  web: "#FF3D00",
  mobile: "#EC4899",
  iot: "#10B981",
  "ai-ml": "#6366F1",
  other: "#F59E0B",
};

// Get thumbnail URL
function getThumbnailUrl(): string {
  if (project.fields.thumbnail?.fields?.file?.url) {
    const url = project.fields.thumbnail.fields.file.url;
    return url.startsWith("//") ? `https:${url}` : url;
  }
  if (project.fields.imageUrl) {
    return project.fields.imageUrl;
  }
  return "https://images.unsplash.com/photo-1555066931-4365d14bab8c?w=1200&h=600&fit=crop&crop=entropy&auto=format&q=80";
}

import { formatMarkdown } from "../../../utils/markdownFormatter";

// Get gallery images
function getGalleryImages(): string[] {
  if (!project.fields.gallery) return [];
  return project.fields.gallery
    .map((asset) => {
      const url = asset.fields?.file?.url || "";
      return url.startsWith("//") ? `https:${url}` : url;
    })
    .filter(Boolean);
}

const galleryImages = getGalleryImages();
---

<BaseLayout
  title={`${project.fields.title} - Muhamad Ali Ridho`}
  description={project.fields.description}
>
  <main class="min-h-screen pt-20">
    <!-- Hero Section -->
    <section class="relative project-hero">
      <!-- Featured Image -->
      <div class="relative h-96 overflow-hidden">
        <img
          src={getThumbnailUrl()}
          alt={project.fields.title}
          class="w-full h-full object-cover"
        />
        <div
          class="absolute inset-0 bg-linear-to-t from-dark-bg via-dark-bg/50 to-transparent"
        >
        </div>
      </div>

      <!-- Content Overlay -->
      <div class="absolute inset-0 flex items-end">
        <div class="max-w-4xl mx-auto px-6 pb-12 w-full">
          <!-- Breadcrumb -->
          <nav class="mb-4">
            <a
              href="/id#projects"
              class="text-primary hover:text-primary-light transition-colors text-sm"
            >
              ‚Üê Kembali ke Proyek
            </a>
          </nav>

          <!-- Category Badge -->
          {
            project.fields.category && (
              <div
                class="inline-block px-3 py-1 rounded-full text-xs font-medium text-white mb-4"
                style={`background: ${categoryColors[project.fields.category] || categoryColors.other}`}
              >
                {(project.fields.category || "other").toUpperCase()}
              </div>
            )
          }

          <!-- Title -->
          <h1
            class="text-display text-3xl md:text-4xl lg:text-5xl mb-4 text-white"
          >
            {project.fields.title}
          </h1>

          <!-- Description -->
          <p class="text-lg text-white/80 max-w-2xl">
            {project.fields.description}
          </p>
        </div>
      </div>
    </section>

    <!-- Project Content -->
    <article class="section-padding">
      <div class="max-w-4xl mx-auto px-6">
        <!-- Tech Stack -->
        {
          project.fields.technologies &&
          project.fields.technologies.length > 0 ? (
            <div class="flex flex-wrap gap-2 mb-8">
              {project.fields.technologies?.map((tech: string) => (
                <span class="px-3 py-1 text-sm rounded-full bg-primary/10 text-primary border border-primary/20">
                  {tech}
                </span>
              ))}
            </div>
          ) : (
            <div class="flex flex-wrap gap-2 mb-8">
              <span class="text-white/40 italic">No technologies listed</span>
            </div>
          )
        }

        <!-- Action Buttons -->
        <div class="flex flex-wrap gap-4 mb-8">
          {
            project.fields.liveUrl && (
              <a
                href={project.fields.liveUrl}
                target="_blank"
                rel="noopener noreferrer"
                class="inline-flex items-center gap-2 px-6 py-3 bg-primary hover:bg-primary-light text-white rounded-lg transition-colors"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
                  />
                </svg>
                Lihat Demo
              </a>
            )
          }
          {
            project.fields.sourceUrl && (
              <a
                href={project.fields.sourceUrl}
                target="_blank"
                rel="noopener noreferrer"
                class="inline-flex items-center gap-2 px-6 py-3 bg-dark-surface border border-dark-border hover:border-primary text-white rounded-lg transition-colors"
              >
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z" />
                </svg>
                Lihat Kode
              </a>
            )
          }
        </div>

        <!-- Content -->
        {
          project.fields.content && (
            <div
              class="rich-text-content mb-12"
              set:html={formatMarkdown(project.fields.content)}
            />
          )
        }

        <!-- Gallery -->
        {
          galleryImages.length > 0 && (
            <div class="mb-12">
              <h2 class="text-2xl font-semibold mb-6">Galeri</h2>
              <div class="grid md:grid-cols-2 gap-4">
                {galleryImages.map((img, index) => (
                  <div
                    class="relative aspect-video overflow-hidden rounded-lg cursor-pointer group"
                    onclick={`openGalleryModal('${img}')`}
                  >
                    <img
                      src={img}
                      alt={`${project.fields.title} screenshot ${index + 1}`}
                      class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"
                      loading="lazy"
                    />
                    <div class="absolute inset-0 bg-dark-bg/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                      <svg
                        class="w-8 h-8 text-white"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"
                        />
                      </svg>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )
        }

        <!-- Navigation -->
        <div class="pt-8 border-t border-dark-border">
          <a
            href="/id#projects"
            class="inline-flex items-center gap-2 text-primary hover:text-primary-light transition-colors"
          >
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 19l-7-7 7-7"></path>
            </svg>
            Kembali ke Proyek
          </a>
        </div>
      </div>
    </article>
  </main>

  <!-- Gallery Modal -->
  <div
    id="gallery-modal"
    class="fixed inset-0 bg-black/90 backdrop-blur-sm z-modal hidden items-center justify-center p-4"
  >
    <button
      onclick="closeGalleryModal()"
      class="absolute top-4 right-4 w-10 h-10 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center transition-colors"
    >
      <svg
        class="w-6 h-6 text-white"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M6 18L18 6M6 6l12 12"></path>
      </svg>
    </button>
    <img
      id="gallery-modal-image"
      src=""
      alt=""
      class="max-w-full max-h-[90vh] object-contain rounded-lg"
    />
  </div>
</BaseLayout>

<script is:inline>
  function openGalleryModal(imageUrl) {
    const modal = document.getElementById("gallery-modal");
    const modalImage = document.getElementById("gallery-modal-image");
    if (modal && modalImage) {
      modalImage.src = imageUrl;
      modal.classList.remove("hidden");
      modal.classList.add("flex");
      document.body.style.overflow = "hidden";
    }
  }

  function closeGalleryModal() {
    const modal = document.getElementById("gallery-modal");
    if (modal) {
      modal.classList.add("hidden");
      modal.classList.remove("flex");
      document.body.style.overflow = "";
    }
  }

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeGalleryModal();
  });

  document.getElementById("gallery-modal")?.addEventListener("click", (e) => {
    if (e.target === e.currentTarget) closeGalleryModal();
  });
</script>

<style>
  /* Rich text content styling - inherits from richText.ts utility */
  /* Rich text styles are now mainly handled by the markdownFormatter utility classes. 
     Global overrides can be placed here if needed but minimizing to avoid conflicts. */
  :global(.rich-text-content) {
    /* Base container styles if any */
  }

  /* Ensure proper spacing for embedded assets */
  .rich-text-content figure {
    margin: 2rem 0;
  }

  .rich-text-content img {
    border-radius: 0.5rem;
    box-shadow:
      0 10px 25px -5px rgba(0, 0, 0, 0.1),
      0 10px 10px -5px rgba(0, 0, 0, 0.04);
  }

  /* Code block enhancements */
  .rich-text-content pre {
    font-family: "JetBrains Mono", "Fira Code", "Consolas", monospace;
    font-size: 0.875rem;
    line-height: 1.5;
  }

  .rich-text-content code {
    font-family: "JetBrains Mono", "Fira Code", "Consolas", monospace;
  }

  /* Table responsive styling */
  .rich-text-content table {
    overflow-x: auto;
    display: block;
    white-space: nowrap;
  }

  @media (min-width: 768px) {
    .rich-text-content table {
      display: table;
      white-space: normal;
    }
  }

  /* Blockquote styling */
  .rich-text-content blockquote {
    position: relative;
  }

  .rich-text-content blockquote::before {
    content: '"';
    position: absolute;
    left: -0.5rem;
    top: -0.5rem;
    font-size: 3rem;
    color: var(--color-primary);
    opacity: 0.3;
  }

  /* Link styling */
  .rich-text-content a {
    text-decoration: underline;
    text-underline-offset: 0.25rem;
    text-decoration-thickness: 1px;
  }

  .rich-text-content a:hover {
    text-decoration-thickness: 2px;
  }

  /* Light mode overrides for blockquote */
  :global(body.light) .rich-text-content blockquote::before {
    color: var(--color-primary);
  }

  /* Keep hero section same as dark mode */
  :global(body.light) .project-hero .text-white {
    color: white !important;
  }

  :global(body.light) .project-hero .text-white\/80 {
    color: rgba(255, 255, 255, 0.8) !important;
  }
</style>
