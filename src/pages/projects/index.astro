---
import Layout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { getSimpleProjects, isContentfulConfigured } from '../../utils/contentful';
import { getLangFromUrl, useTranslations } from '../../i18n/utils';

const lang = getLangFromUrl(Astro.url);
const locale = lang === 'id' ? 'id-ID' : 'en-US';
const t = useTranslations(lang);

// Try to get projects from Contentful first, fallback to static content
let projects: any[] = [];

try {
  if (isContentfulConfigured()) {
    const contentfulProjects = await getSimpleProjects(false, locale);
    if (contentfulProjects.length > 0) {
      // Transform Contentful projects to match expected structure
      projects = contentfulProjects.map(project => {
        // Get image: prefer uploaded asset, then imageUrl field, then default
        let thumbnailUrl = `https://images.unsplash.com/photo-1555066931-4365d14bab8c?w=800&h=600&fit=crop&crop=entropy&auto=format&q=80`;
        if (project.fields.thumbnail?.fields?.file?.url) {
          thumbnailUrl = project.fields.thumbnail.fields.file.url.startsWith('//')
            ? `https:${project.fields.thumbnail.fields.file.url}`
            : project.fields.thumbnail.fields.file.url;
        } else if (project.fields.imageUrl) {
          thumbnailUrl = project.fields.imageUrl;
        }
        
        return {
          id: project.sys.id,
          slug: project.fields.slug,
          data: {
            title: project.fields.title,
            description: project.fields.description,
            category: project.fields.category,
            featured: project.fields.featured,
            publishedAt: project.sys.createdAt,
            thumbnail: thumbnailUrl,
            technologies: project.fields.technologies || getDefaultTechnologies(project.fields.category),
            liveUrl: project.fields.liveUrl || undefined,
            sourceUrl: project.fields.sourceUrl || 'https://github.com/muhamadaliridho'
          }
        };
      });
    }
  }
} catch (error) {
  console.warn('Error fetching from Contentful:', error);
}

// Fallback to static content if Contentful is not available or empty
if (projects.length === 0) {
  try {
    const staticProjects = await getCollection('projects');
    projects = staticProjects;
  } catch (error) {
    console.warn('Error fetching static projects:', error);
    // Use hardcoded fallback data
    projects = [
      {
        id: 'fallback-1',
        slug: 'portfolio-website',
        data: {
          title: 'Portfolio Website',
          description: 'Modern portfolio website built with Astro and Tailwind CSS',
          category: 'web',
          featured: true,
          publishedAt: '2024-01-01T00:00:00Z',
          thumbnail: 'https://images.unsplash.com/photo-1555066931-4365d14bab8c?w=800&h=600&fit=crop&crop=entropy&auto=format&q=80',
          technologies: ['Astro', 'TypeScript', 'Tailwind CSS'],
          liveUrl: '#',
          sourceUrl: 'https://github.com/muhamadaliridho'
        }
      }
    ];
  }
}

// Helper functions for default data
function getDefaultTechnologies(category: string): string[] {
  const techMap: Record<string, string[]> = {
    web: ['React', 'TypeScript', 'Tailwind CSS', 'Node.js'],
    mobile: ['React Native', 'TypeScript', 'Redux', 'Firebase'],
    iot: ['ESP32', 'Arduino', 'C++', 'MQTT'],
    'ai-ml': ['Python', 'TensorFlow', 'Pandas', 'Scikit-learn'],
    other: ['JavaScript', 'HTML', 'CSS']
  };
  return techMap[category] || techMap.other;
}

const sortedProjects = projects.sort((a, b) => 
  new Date(b.data.publishedAt).getTime() - new Date(a.data.publishedAt).getTime()
);

// Get unique categories and normalize them
// const rawCategories = [...new Set(projects.map(p => p.data.category).filter(Boolean))];
// const categories = [
//   { id: 'all', label: t('category.all' as any) },
//   ...rawCategories.map(cat => ({
//     id: cat,
//     // Try to translate if key exists, else capitalize the raw category
//     label: t(`category.${cat}` as any) !== `category.${cat}` 
//       ? t(`category.${cat}` as any) 
//       : cat.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ')
//   }))
// ];

// Extract unique categories from projects
const uniqueCategories = [
  ...new Set(projects.map((project) => project.data.category).filter(Boolean)),
];

// Create category objects with labels
const categories = [
  { id: "all", label: t("category.all" as any) },
  ...uniqueCategories.map((cat) => {
    // Try to get translation, fallback to formatted text
    const translationKey = `category.${cat}`;
    const translatedLabel = t(translationKey as any);
    
    // Check if translation exists (if it returns the key, it means missing)
    // Note: This loose check assumes your i18n returns key on miss
    const label = translatedLabel !== translationKey 
      ? translatedLabel 
      : cat.split('-').map((word: string) => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');

    return { id: cat, label };
  }),
];
---

<Layout title={`${t('projects.title')} | Muhamad Ali Ridho`}>
  <main class="pt-32 pb-20 px-6">
    <div class="max-w-7xl mx-auto">
      <!-- Section Header -->
      <div class="text-center mb-16">
        <h1 class="text-display text-4xl md:text-5xl lg:text-6xl mb-6">
          {t('projects.title')}
        </h1>
        <p class="text-muted max-w-2xl mx-auto text-lg">
          {t('section.projects.desc')}
        </p>
      </div>

      <!-- Category Filter -->
      <div class="flex flex-wrap justify-center gap-3 mb-16">
        {categories.map((cat) => (
          <button
            class="filter-btn px-5 py-2 rounded-full text-sm font-medium
                   border border-dark-border bg-dark-surface
                   hover:border-primary hover:text-primary
                   transition-all duration-300 focus-ring interactive
                   data-[active=true]:bg-primary data-[active=true]:border-primary data-[active=true]:text-white"
            data-category={cat.id}
            data-active={cat.id === 'all' ? 'true' : 'false'}
            data-cursor-hover
          >
            {cat.label}
          </button>
        ))}
      </div>

      <!-- Projects Grid -->
      <div id="projects-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        {sortedProjects.map((project) => (
          <article
            class="project-card group card-elevated"
            data-category={project.data.category}
            data-cursor-hover
          >
            <!-- Thumbnail -->
            <div class="relative aspect-video overflow-hidden">
              <div class="absolute inset-0 bg-linear-to-br from-primary/20 to-secondary/20"></div>
              <img
                src={project.data.thumbnail}
                alt={project.data.title}
                class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"
                loading="lazy"
              />
              <!-- Category Badge -->
              <div 
                    class="absolute top-4 left-4 px-3 py-1 rounded-full text-xs font-medium text-white shadow-sm"
                    style={{ background: `var(--color-cat-${project.data.category})` }}
                  >
                    {project.data.category.toUpperCase()}
                  </div>
              <!-- Overlay on hover -->
              <div class="absolute inset-0 bg-dark-bg/80 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center justify-center gap-4">
                {project.data.liveUrl && (
                  <a
                    href={project.data.liveUrl}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="w-12 h-12 rounded-full bg-primary flex items-center justify-center
                           hover:scale-110 transition-transform"
                    aria-label={`View live demo of ${project.data.title}`}
                    title={t('projects.viewLive' as any)}
                  >
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                    </svg>
                  </a>
                )}
                {project.data.sourceUrl && (
                  <a
                    href={project.data.sourceUrl}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="w-12 h-12 rounded-full bg-dark-surface border border-dark-border flex items-center justify-center
                           hover:scale-110 hover:border-secondary transition-all"
                    aria-label={`View source code of ${project.data.title} on GitHub`}
                    title={t('projects.viewSource' as any)}
                  >
                    <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                      <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                    </svg>
                  </a>
                )}
              </div>
            </div>

            <!-- Content -->
            <div class="p-6">
              <a href={`/projects/${project.slug}`} class="block">
                <h3 class="text-xl font-semibold mb-2 group-hover:text-primary transition-colors">
                  {project.data.title}
                </h3>
              </a>
              <p class="text-muted text-sm mb-4 line-clamp-2">
                {project.data.description}
              </p>
              
              <!-- Tech Stack -->
              <div class="flex flex-wrap gap-2 mb-4">
                {project.data.technologies.slice(0, 4).map((tech: string) => (
                  <span class="px-2 py-1 text-xs rounded-md bg-white/5 text-subtle">
                    {tech}
                  </span>
                ))}
                {project.data.technologies.length > 4 && (
                  <span class="px-2 py-1 text-xs rounded-md bg-white/5 text-subtle">
                    +{project.data.technologies.length - 4}
                  </span>
                )}
              </div>

              <!-- View Details Link -->
              <a 
                href={`/projects/${project.slug}`}
                aria-label={`View details of ${project.data.title} project`}
                class="inline-flex items-center gap-2 text-primary hover:text-primary-light transition-colors text-sm font-medium"
              >
                {t('projects.viewProject' as any)}
                <svg class="w-4 h-4 transition-transform group-hover:translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                </svg>
              </a>
            </div>
          </article>
        ))}
      </div>
    </div>
  </main>
</Layout>

<script>
  // Category filter functionality
  const filterBtns = document.querySelectorAll('.filter-btn');
  const projectCards = document.querySelectorAll('.project-card');

  filterBtns.forEach((btn) => {
    btn.addEventListener('click', () => {
      const category = btn.getAttribute('data-category');
      
      // Update active state
      filterBtns.forEach((b) => b.setAttribute('data-active', 'false'));
      btn.setAttribute('data-active', 'true');
      
      // Filter projects
      projectCards.forEach((card) => {
        const cardCategory = card.getAttribute('data-category');
        if (category === 'all' || cardCategory === category) {
          (card as HTMLElement).style.display = 'block';
          setTimeout(() => {
            (card as HTMLElement).style.opacity = '1';
            (card as HTMLElement).style.transform = 'translateY(0)';
          }, 50);
        } else {
          (card as HTMLElement).style.opacity = '0';
          (card as HTMLElement).style.transform = 'translateY(20px)';
          setTimeout(() => {
            (card as HTMLElement).style.display = 'none';
          }, 300);
        }
      });
    });
  });
</script>

<style>
  /* Light mode styles for projects page */
  :global(body.light) main {
    background-color: var(--color-light-bg);
  }
  
  :global(body.light) h1,
  :global(body.light) h2,
  :global(body.light) h3 {
    color: #1F2937;
  }
  
  /* Card title */
  :global(body.light) .card-elevated h3 {
    color: #1F2937;
  }
  
  :global(body.light) .card-elevated:hover h3,
  :global(body.light) .card-elevated h3 a:hover {
    color: #C62D00;
  }
  
  /* Tech stack tags */
  :global(body.light) .bg-white\/5 {
    background-color: rgba(0, 0, 0, 0.08) !important;
    color: #374151 !important;
  }
  
  /* Filter buttons */
  :global(body.light) .filter-btn {
    background-color: #FFFFFF;
    border-color: #E5E7EB;
    color: #1F2937;
  }
  
  :global(body.light) .filter-btn:hover {
    border-color: #C62D00;
    color: #C62D00;
  }
  
  :global(body.light) .filter-btn[data-active="true"] {
    background-color: #C62D00;
    border-color: #C62D00;
    color: white;
  }
</style>
