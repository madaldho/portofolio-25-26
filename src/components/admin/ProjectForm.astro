---
// Project Creation/Edit Form Component
---

<div
  id="project-modal"
  class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center p-4 z-modal overlay-active"
>
  <div
    class="bg-dark-surface rounded-2xl border border-dark-border max-w-2xl w-full max-h-[90vh] overflow-hidden"
  >
    <!-- Modal Header -->
    <div
      class="flex items-center justify-between p-6 border-b border-dark-border"
    >
      <h2
        id="project-modal-title"
        class="text-2xl font-display font-bold text-white"
      >
        Create Project
      </h2>
      <button
        id="close-project-modal"
        class="w-8 h-8 rounded-lg hover:bg-dark-border transition-colors flex items-center justify-center"
      >
        <svg
          class="w-5 h-5 text-white/60"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <!-- Modal Content -->
    <div class="p-6 overflow-y-auto max-h-[calc(90vh-140px)]">
      <form id="project-form" class="space-y-6">
        <!-- Title -->
        <div>
          <label
            for="project-title"
            class="block text-sm font-medium text-white mb-2"
          >
            Title *
          </label>
          <input
            type="text"
            id="project-title"
            name="title"
            required
            class="w-full px-4 py-3 bg-dark-bg border border-dark-border rounded-lg
                   text-white placeholder-white/40 focus:border-primary focus:ring-1 focus:ring-primary
                   transition-colors"
            placeholder="Enter project title..."
          />
        </div>

        <!-- Slug -->
        <div>
          <label
            for="project-slug"
            class="block text-sm font-medium text-white mb-2"
          >
            Slug *
          </label>
          <input
            type="text"
            id="project-slug"
            name="slug"
            required
            class="w-full px-4 py-3 bg-dark-bg border border-dark-border rounded-lg
                   text-white placeholder-white/40 focus:border-primary focus:ring-1 focus:ring-primary
                   transition-colors"
            placeholder="project-slug"
          />
          <p class="text-xs text-white/60 mt-1">
            URL-friendly version of the title
          </p>
        </div>

        <!-- Description -->
        <div>
          <label
            for="project-description"
            class="block text-sm font-medium text-white mb-2"
          >
            Description *
          </label>
          <textarea
            id="project-description"
            name="description"
            required
            rows="4"
            class="w-full px-4 py-3 bg-dark-bg border border-dark-border rounded-lg
                   text-white placeholder-white/40 focus:border-primary focus:ring-1 focus:ring-primary
                   transition-colors resize-vertical"
            placeholder="Describe your project..."></textarea>
        </div>

        <!-- Category -->
        <div>
          <label
            for="project-category"
            class="block text-sm font-medium text-white mb-2"
          >
            Category *
          </label>
          <select
            id="project-category"
            name="category"
            required
            class="w-full px-4 py-3 bg-dark-bg border border-dark-border rounded-lg
                   text-white focus:border-primary focus:ring-1 focus:ring-primary
                   transition-colors"
          >
            <option value="">Select a category</option>
            <option value="web">Web Development</option>
            <option value="mobile">Mobile Development</option>
            <option value="iot">IoT & Hardware</option>
            <option value="ai-ml">AI & Machine Learning</option>
            <option value="other">Other</option>
          </select>
        </div>

        <!-- Technologies -->
        <div>
          <label
            for="project-technologies"
            class="block text-sm font-medium text-white mb-2"
          >
            Technologies
          </label>
          <input
            type="text"
            id="project-technologies"
            name="technologies"
            class="w-full px-4 py-3 bg-dark-bg border border-dark-border rounded-lg
                   text-white placeholder-white/40 focus:border-primary focus:ring-1 focus:ring-primary
                   transition-colors"
            placeholder="React, Node.js, MongoDB"
          />
          <p class="text-xs text-white/60 mt-1">
            Separate technologies with commas
          </p>
        </div>

        <!-- URLs -->
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label
              for="project-live-url"
              class="block text-sm font-medium text-white mb-2"
            >
              Live URL
            </label>
            <input
              type="url"
              id="project-live-url"
              name="liveUrl"
              class="w-full px-4 py-3 bg-dark-bg border border-dark-border rounded-lg
                     text-white placeholder-white/40 focus:border-primary focus:ring-1 focus:ring-primary
                     transition-colors"
              placeholder="https://example.com"
            />
          </div>
          <div>
            <label
              for="project-source-url"
              class="block text-sm font-medium text-white mb-2"
            >
              Source URL
            </label>
            <input
              type="url"
              id="project-source-url"
              name="sourceUrl"
              class="w-full px-4 py-3 bg-dark-bg border border-dark-border rounded-lg
                     text-white placeholder-white/40 focus:border-primary focus:ring-1 focus:ring-primary
                     transition-colors"
              placeholder="https://github.com/username/repo"
            />
          </div>
        </div>

        <!-- Featured -->
        <div class="flex items-center gap-3">
          <input
            type="checkbox"
            id="project-featured"
            name="featured"
            class="w-4 h-4 text-primary bg-dark-bg border-dark-border rounded
                   focus:ring-primary focus:ring-2"
          />
          <label for="project-featured" class="text-sm font-medium text-white">
            Featured Project
          </label>
        </div>

        <!-- Error Messages -->
        <div
          id="project-form-errors"
          class="hidden bg-red-500/10 border border-red-500/20 rounded-lg p-4"
        >
          <div class="flex items-start gap-3">
            <svg
              class="w-5 h-5 text-red-400 mt-0.5 shrink-0"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div>
              <h4 class="text-red-400 font-medium mb-1">
                Please fix the following errors:
              </h4>
              <ul
                id="project-error-list"
                class="text-red-300 text-sm space-y-1"
              >
              </ul>
            </div>
          </div>
        </div>

        <!-- Success Message -->
        <div
          id="project-form-success"
          class="hidden bg-green-500/10 border border-green-500/20 rounded-lg p-4"
        >
          <div class="flex items-center gap-3">
            <svg
              class="w-5 h-5 text-green-400"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M5 13l4 4L19 7"></path>
            </svg>
            <p class="text-green-400">Project saved successfully!</p>
          </div>
        </div>
      </form>
    </div>

    <!-- Modal Footer -->
    <div
      class="flex items-center justify-between p-6 border-t border-dark-border"
    >
      <button
        type="button"
        id="cancel-project-btn"
        class="px-6 py-2 text-white/70 hover:text-white transition-colors"
      >
        Cancel
      </button>
      <button
        type="submit"
        form="project-form"
        id="save-project-btn"
        class="px-6 py-2 bg-secondary hover:bg-secondary-dark text-white rounded-lg
               transition-colors flex items-center gap-2"
      >
        <span>Save Project</span>
        <svg
          class="w-4 h-4"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M5 13l4 4L19 7"></path>
        </svg>
      </button>
    </div>
  </div>
</div>

<script>
  import {
    cmsManager,
    CMSManager,
    type ProjectData,
  } from "../../utils/cmsManager";

  const modal = document.getElementById("project-modal");
  const form = document.getElementById("project-form") as HTMLFormElement;
  const closeBtn = document.getElementById("close-project-modal");
  const cancelBtn = document.getElementById("cancel-project-btn");
  const saveBtn = document.getElementById("save-project-btn");

  const titleInput = document.getElementById(
    "project-title"
  ) as HTMLInputElement;
  const slugInput = document.getElementById("project-slug") as HTMLInputElement;

  const errorContainer = document.getElementById("project-form-errors");
  const errorList = document.getElementById("project-error-list");
  const successContainer = document.getElementById("project-form-success");

  let isEditing = false;
  let editingId: string | null = null;

  // Auto-generate slug from title
  titleInput?.addEventListener("input", () => {
    if (!isEditing && slugInput) {
      slugInput.value = CMSManager.generateSlug(titleInput.value);
    }
  });

  // Open modal
  function openProjectModal(editData?: any) {
    if (modal) {
      modal.classList.remove("hidden");
      modal.classList.add("flex");
      document.body.style.overflow = "hidden";

      if (editData) {
        isEditing = true;
        editingId = editData.id;
        populateForm(editData);
        document.getElementById("project-modal-title")!.textContent =
          "Edit Project";
      } else {
        isEditing = false;
        editingId = null;
        form?.reset();
        document.getElementById("project-modal-title")!.textContent =
          "Create Project";
      }

      hideMessages();
      titleInput?.focus();
    }
  }

  // Close modal
  function closeProjectModal() {
    if (modal) {
      modal.classList.add("hidden");
      modal.classList.remove("flex");
      document.body.style.overflow = "";
      form?.reset();
      hideMessages();
    }
  }

  // Populate form for editing
  function populateForm(data: any) {
    if (titleInput) titleInput.value = data.fields.title["en-US"] || "";
    if (slugInput) slugInput.value = data.fields.slug["en-US"] || "";

    const descriptionInput = document.getElementById(
      "project-description"
    ) as HTMLTextAreaElement;
    if (descriptionInput)
      descriptionInput.value = data.fields.description["en-US"] || "";

    const categoryInput = document.getElementById(
      "project-category"
    ) as HTMLSelectElement;
    if (categoryInput)
      categoryInput.value = data.fields.category["en-US"] || "";

    const technologiesInput = document.getElementById(
      "project-technologies"
    ) as HTMLInputElement;
    if (technologiesInput && data.fields.technologies) {
      technologiesInput.value = data.fields.technologies["en-US"].join(", ");
    }

    const liveUrlInput = document.getElementById(
      "project-live-url"
    ) as HTMLInputElement;
    if (liveUrlInput) liveUrlInput.value = data.fields.liveUrl?.["en-US"] || "";

    const sourceUrlInput = document.getElementById(
      "project-source-url"
    ) as HTMLInputElement;
    if (sourceUrlInput)
      sourceUrlInput.value = data.fields.sourceUrl?.["en-US"] || "";

    const featuredInput = document.getElementById(
      "project-featured"
    ) as HTMLInputElement;
    if (featuredInput)
      featuredInput.checked = data.fields.featured?.["en-US"] || false;
  }

  // Show/hide messages
  function showError(errors: string[]) {
    if (errorContainer && errorList) {
      errorList.innerHTML = errors
        .map((error) => `<li>â€¢ ${error}</li>`)
        .join("");
      errorContainer.classList.remove("hidden");
    }
    if (successContainer) {
      successContainer.classList.add("hidden");
    }
  }

  function showSuccess() {
    if (successContainer) {
      successContainer.classList.remove("hidden");
    }
    if (errorContainer) {
      errorContainer.classList.add("hidden");
    }
  }

  function hideMessages() {
    if (errorContainer) errorContainer.classList.add("hidden");
    if (successContainer) successContainer.classList.add("hidden");
  }

  // Form submission
  async function handleSubmit() {
    const formData = new FormData(form);
    const technologies =
      (formData.get("technologies") as string)
        ?.split(",")
        .map((tech) => tech.trim())
        .filter(Boolean) || [];

    const projectData: ProjectData = {
      title: formData.get("title") as string,
      slug: formData.get("slug") as string,
      description: formData.get("description") as string,
      category: formData.get("category") as ProjectData["category"],
      featured: formData.has("featured"),
      technologies,
      liveUrl: (formData.get("liveUrl") as string) || undefined,
      sourceUrl: (formData.get("sourceUrl") as string) || undefined,
    };

    // Validate
    const errors = CMSManager.validateProject(projectData);
    if (errors.length > 0) {
      showError(errors);
      return;
    }

    try {
      let result;
      if (isEditing && editingId) {
        result = await cmsManager.updateContent(editingId, projectData);
      } else {
        result = await cmsManager.createProject(projectData);
      }

      if (result) {
        showSuccess();

        // Close modal after delay
        setTimeout(() => {
          closeProjectModal();
          // Refresh dashboard data
          window.dispatchEvent(new CustomEvent("refreshDashboard"));
        }, 1500);
      } else {
        showError(["Failed to save project. Please try again."]);
      }
    } catch (error) {
      console.error("Error saving project:", error);
      showError(["An unexpected error occurred. Please try again."]);
    }
  }

  // Event listeners
  closeBtn?.addEventListener("click", closeProjectModal);
  cancelBtn?.addEventListener("click", closeProjectModal);

  form?.addEventListener("submit", (e) => {
    e.preventDefault();
    handleSubmit();
  });

  // Close modal on outside click
  modal?.addEventListener("click", (e) => {
    if (e.target === modal) {
      closeProjectModal();
    }
  });

  // Expose functions globally
  (window as any).openProjectModal = openProjectModal;
  (window as any).closeProjectModal = closeProjectModal;
</script>

<style>
  :global(body.light) #project-modal .bg-dark-surface {
    background-color: var(--color-light-surface);
  }

  :global(body.light) #project-modal .border-dark-border {
    border-color: var(--color-light-border);
  }

  :global(body.light) #project-modal .bg-dark-bg {
    background-color: var(--color-light-bg);
  }

  :global(body.light) #project-modal .text-white {
    color: var(--color-dark-bg);
  }

  :global(body.light) #project-modal .text-white\/70 {
    color: rgba(10, 10, 10, 0.7);
  }

  :global(body.light) #project-modal .text-white\/60 {
    color: rgba(10, 10, 10, 0.6);
  }

  :global(body.light) #project-modal .text-white\/40 {
    color: rgba(10, 10, 10, 0.4);
  }
</style>
