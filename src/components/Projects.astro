---
import { getCollection } from 'astro:content';
import { getSimpleProjects, isContentfulConfigured } from '../utils/contentful';
import { getLangFromUrl, useTranslations, useTranslatedPath } from '../i18n/utils';

const lang = getLangFromUrl(Astro.url);
const locale = 'id-ID'; // Always Indonesian
const t = useTranslations(lang);
const translatePath = useTranslatedPath(lang);

// Try to get projects from Contentful first, fallback to static content
let projects: any[] = [];

try {
  if (isContentfulConfigured()) {
    const contentfulProjects = await getSimpleProjects(false, locale);
    if (contentfulProjects.length > 0) {
      // Transform Contentful projects to match expected structure with data validation
      projects = contentfulProjects.map(project => {
        // Skip projects with poor quality data
        if (!project.fields.title || 
            !project.fields.description || 
            project.fields.title.trim().length < 3 ||
            project.fields.description.trim().length < 10 ||
            (project.fields.technologies && project.fields.technologies.some((tech: string) => 
              tech.length < 2 || ['apa', 'aja', 'lah', 'test', 'dummy'].includes(tech.toLowerCase())
            ))) {
          return null; // Skip this project
        }

        // Get image: prefer uploaded asset, then imageUrl field, then default
        let thumbnailUrl = `https://images.unsplash.com/photo-1555066931-4365d14bab8c?w=800&h=600&fit=crop&crop=entropy&auto=format&q=80`;
        if (project.fields.thumbnail?.fields?.file?.url) {
          thumbnailUrl = project.fields.thumbnail.fields.file.url.startsWith('//')
            ? `https:${project.fields.thumbnail.fields.file.url}`
            : project.fields.thumbnail.fields.file.url;
        } else if (project.fields.imageUrl) {
          thumbnailUrl = project.fields.imageUrl;
        }

        // Normalize category - accept all valid Contentful categories
        let category = project.fields.category;
        const validCategories = ['web', 'mobile', 'landing page', 'design', 'video', 'other'];
        if (!category || !validCategories.includes(category)) {
          // Try to infer category from title or technologies
          const title = project.fields.title.toLowerCase();
          const techs = (project.fields.technologies || []).join(' ').toLowerCase();
          
          if (title.includes('landing') || title.includes('page')) {
            category = 'landing page';
          } else if (title.includes('design') || title.includes('ui') || title.includes('ux') || techs.includes('figma')) {
            category = 'design';
          } else if (title.includes('video') || title.includes('motion') || techs.includes('premiere') || techs.includes('after effects')) {
            category = 'video';
          } else if (title.includes('web') || title.includes('website') || techs.includes('react') || techs.includes('astro') || techs.includes('html')) {
            category = 'web';
          } else if (title.includes('mobile') || title.includes('app') || techs.includes('react native') || techs.includes('flutter')) {
            category = 'mobile';
          } else {
            category = 'other';
          }
        }
        
        return {
          id: project.sys.id,
          slug: project.fields.slug,
          data: {
            title: project.fields.title.trim(),
            description: project.fields.description.trim(),
            category: category,
            featured: project.fields.featured,
            publishedAt: project.sys.createdAt,
            thumbnail: thumbnailUrl,
            technologies: project.fields.technologies?.filter((tech: string) => 
              tech && tech.trim().length > 1 && !['apa', 'aja', 'lah', 'test', 'dummy'].includes(tech.toLowerCase().trim())
            ) || getDefaultTechnologies(category),
            liveUrl: project.fields.liveUrl || undefined,
            sourceUrl: project.fields.sourceUrl || undefined
          }
        };
      }).filter(Boolean); // Remove null entries
    }
  }
} catch (error) {
  console.warn('Error fetching from Contentful:', error);
}

// Fallback to static content if Contentful is not available or empty
if (projects.length === 0) {
  try {
    const staticProjects = await getCollection('projects');
    projects = staticProjects;
  } catch (error) {
    console.warn('Error fetching static projects:', error);
    // Use hardcoded fallback data
    projects = [
      {
        id: 'fallback-1',
        slug: 'portfolio-website',
        data: {
          title: 'Portfolio Website',
          description: 'Modern portfolio website built with Astro and Tailwind CSS',
          category: 'web',
          featured: true,
          publishedAt: '2024-01-01T00:00:00Z',
          thumbnail: 'https://images.unsplash.com/photo-1555066931-4365d14bab8c?w=800&h=600&fit=crop&crop=entropy&auto=format&q=80',
          technologies: ['Astro', 'TypeScript', 'Tailwind CSS'],
          liveUrl: '#',
          sourceUrl: 'https://github.com/muhamadaliridho'
        }
      }
    ];
  }
}

// Helper functions for default data
function getDefaultTechnologies(category: string): string[] {
  const techMap: Record<string, string[]> = {
    web: ['React', 'TypeScript', 'Tailwind CSS', 'Node.js'],
    mobile: ['React Native', 'TypeScript', 'Redux', 'Firebase'],
    iot: ['ESP32', 'Arduino', 'C++', 'MQTT'],
    'ai-ml': ['Python', 'TensorFlow', 'Pandas', 'Scikit-learn'],
    other: ['JavaScript', 'HTML', 'CSS']
  };
  return techMap[category] || techMap.other;
}

const sortedProjects = projects.sort((a, b) => 
  new Date(b.data.publishedAt).getTime() - new Date(a.data.publishedAt).getTime()
);

// Define proper category mapping first - includes all Contentful categories
const categoryMapping: Record<string, string> = {
  'web': 'Web Development',
  'mobile': 'Mobile Development', 
  'landing page': 'Landing Page',
  'design': 'Design',
  'video': 'Video',
  'other': 'Other Projects'
};

// Extract unique categories from projects and clean them up
const uniqueCategories = [
  ...new Set(projects.map((project) => project.data.category).filter(Boolean)),
].filter(cat => cat && cat.trim() !== ''); // Include all categories from projects

// Create category objects with proper labels
const categories = [
  { id: "all", label: t("category.all" as any) || "All Projects" },
  ...uniqueCategories.map((cat) => ({
    id: cat,
    label: categoryMapping[cat] || cat.split('-').map((w: string) => w.charAt(0).toUpperCase() + w.slice(1)).join(' ')
  }))
];

const categoryColors: Record<string, string> = {
  web: '#FF3D00',
  mobile: '#EC4899',
  'landing page': '#8B5CF6',
  design: '#06B6D4',
  video: '#EF4444',
  other: '#F59E0B',
};

// Add CSS custom properties for category colors
const categoryColorVars = Object.entries(categoryColors)
  .map(([key, color]) => `--color-cat-${key}: ${color}`)
  .join('; ');
---

<section id="projects" class="section-padding relative" style={categoryColorVars}>
  <div class="max-w-7xl mx-auto px-6">
    <!-- Section Header -->
    <div class="text-center mb-12">
      <p class="text-primary font-mono text-sm mb-4">// {t('section.projects.label')}</p>
      <h2 class="text-display text-4xl md:text-5xl lg:text-6xl mb-4">
        {t('projects.title')}
      </h2>
      <p class="text-muted max-w-2xl mx-auto">
        {t('section.projects.desc')}
      </p>
    </div>

    <!-- Category Filter -->
    <div class="flex flex-wrap justify-center gap-3 mb-12">
      {categories.map((cat) => (
        <button
          class="filter-btn px-5 py-2 rounded-full text-sm font-medium
                 border border-dark-border bg-dark-surface
                 hover:border-primary hover:text-primary
                 transition-all duration-300 focus-ring interactive
                 data-[active=true]:bg-primary data-[active=true]:border-primary data-[active=true]:text-white"
          data-category={cat.id}
          data-active={cat.id === 'all' ? 'true' : 'false'}
          data-cursor-hover
        >
          {cat.label}
        </button>
      ))}
    </div>
    <!-- Projects Grid -->
    <div id="projects-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
      {sortedProjects.map((project, index) => (
        <article
          class="project-card group card-elevated"
          data-category={project.data.category}
          data-cursor-hover
          style={index >= 6 ? "display: none;" : ""}
        >
          <!-- Thumbnail -->
          <div class="relative aspect-video overflow-hidden">
            <div class="absolute inset-0 bg-linear-to-br from-primary/20 to-secondary/20"></div>
            <img
              src={project.data.thumbnail}
              alt={project.data.title}
              class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"
              loading="lazy"
            />
            <!-- Category Badge -->
            <div 
                  class="absolute top-4 left-4 px-3 py-1 rounded-full text-xs font-medium text-white shadow-sm"
                  style={{ background: `var(--color-cat-${project.data.category})` }}
                >
                  {categoryMapping[project.data.category] || project.data.category.toUpperCase()}
            </div>
            <!-- Mobile: No Overlay needed as buttons are moved below -->
            <!-- Desktop Hover Overlay for aesthetic depth (optional, or remove if redundant) -->
            <div class="hidden md:block absolute inset-0 bg-dark-bg/20 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
          </div>

          <!-- Content -->
          <div class="p-6">
            <a href={`/projects/${project.slug}`} class="block">
              <h3 class="text-xl font-semibold mb-2 group-hover:text-primary transition-colors">
                {project.data.title}
              </h3>
            </a>
            <p class="text-muted text-sm mb-4 line-clamp-2">
              {project.data.description}
            </p>
            
            <!-- Tech Stack -->
            <div class="flex flex-wrap gap-2 mb-4">
              {project.data.technologies.slice(0, 4).map((tech: string) => (
                <span class="px-2 py-1 text-xs rounded-md bg-white/5 text-subtle">
                  {tech}
                </span>
              ))}
              {project.data.technologies.length > 4 && (
                <span class="px-2 py-1 text-xs rounded-md bg-white/5 text-subtle">
                  +{project.data.technologies.length - 4}
                </span>
              )}
            </div>

            <!-- View Details Link & Actions -->
            <div class="flex items-center justify-between pt-4 border-t border-dark-border/30">
              <a 
                href={`/projects/${project.slug}`}
                aria-label={`View details of ${project.data.title} project`}
                class="inline-flex items-center gap-2 text-primary hover:text-primary-light transition-colors text-sm font-medium"
              >
                {t('projects.viewProject' as any)}
                <svg class="w-4 h-4 transition-transform group-hover:translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                </svg>
              </a>

              <div class="flex items-center gap-3">
                 {project.data.liveUrl && (
                  <a
                    href={project.data.liveUrl}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="text-subtle hover:text-primary transition-colors"
                    aria-label={`View live demo of ${project.data.title}`}
                    title={t('projects.viewLive' as any)}
                  >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                    </svg>
                  </a>
                )}
                {project.data.sourceUrl && (
                  <a
                    href={project.data.sourceUrl}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="text-subtle hover:text-primary transition-colors"
                    aria-label={`View source code of ${project.data.title} on GitHub`}
                    title={t('projects.viewSource' as any)}
                  >
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                      <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                    </svg>
                  </a>
                )}
            </div>
            </div>
          </div>
        </article>
      ))}
    </div>
    </div>

    <!-- View All Projects Button -->
    <div class="text-center mt-12">
      <a 
        href={translatePath('/projects')}
        class="btn-secondary min-w-[160px]"
        data-cursor-hover
      >
        {t('projects.viewAll' as any) || 'View All Projects'}
      </a>
    </div>
  </div>
</section>

<script>
  // Category filter functionality
  const filterBtns = document.querySelectorAll('.filter-btn');
  const projectCards = document.querySelectorAll('.project-card');

  filterBtns.forEach((btn) => {
    btn.addEventListener('click', () => {
      const category = btn.getAttribute('data-category');
      
      // Update active state
      filterBtns.forEach((b) => b.setAttribute('data-active', 'false'));
      btn.setAttribute('data-active', 'true');
      
      // Filter projects - show up to 6 projects per category
      let visibleCount = 0;
      
      projectCards.forEach((card) => {
        const cardCategory = card.getAttribute('data-category');
        const isMatch = category === 'all' || cardCategory === category;

        if (isMatch && visibleCount < 6) {
          visibleCount++;
          (card as HTMLElement).style.display = 'block';
          // Small timeout to allow display:block to apply before opacity transition
          setTimeout(() => {
            (card as HTMLElement).style.opacity = '1';
            (card as HTMLElement).style.transform = 'translateY(0)';
          }, 10);
        } else {
          (card as HTMLElement).style.opacity = '0';
          (card as HTMLElement).style.transform = 'translateY(20px)';
          setTimeout(() => {
            (card as HTMLElement).style.display = 'none';
          }, 300);
        }
      });
    });
  });
</script>

<style>
  .project-card {
    transition: opacity 0.3s, transform 0.3s;
  }
  
  :global(body.light) #projects {
    background-color: var(--color-light-bg);
  }
  
  :global(body.light) #projects h2,
  :global(body.light) #projects h3 {
    color: var(--color-dark-bg);
  }
  
  :global(body.light) #projects .bg-dark-surface {
    background-color: var(--color-light-surface);
  }
  
  :global(body.light) #projects .border-dark-border {
    border-color: var(--color-light-border);
  }
  
  /* Light mode filter button - active state */
  :global(body.light) .filter-btn[data-active="true"] {
    background-color: var(--color-primary) !important;
    border-color: var(--color-primary) !important;
    color: #ffffff !important;
  }
  /* Wait, if I make it primary background (orange) and white text, that works well.
     The user said: "warna aktif textnya oren nyaru sama warna tombolnya (orange blends with button)".
     This likely meant: Text was orange, Background was (light) orange/transparent -> Low Contrast.
     OR: Text was orange, Background was orange -> Invisible.
     The previous code was: bg: primary-light (#FFF3E0), text: primary (Orange).
     Maybe primary-light is too close to primary color?
     The user said "harusny item" (should be black).
     If I want to follow "should be black", I should set color: black.
     BUT standard "Active" pills are usually solid color block with white text.
     Let's try SOLID PRIMARY background with WHITE text. That is high contrast.
     OR if they really want black text, maybe on white background?
     "oren nyaru sama warna tombolnya" -> Orange blends with button color.
     "harusny item" -> Should be black.
     If I use:
     Background: Transparent/Light Surface
     Border: Primary
     Text: Black (or Primary?)
     
     Actually, if I just swap it to:
     Background: Primary (Orange)
     Text: White
     That fixes "Nyaru" (blending).
     AND it is consistent with Dark Mode (usually filled).
     But if the user specifically asked for "item" (black) text...
     Maybe they want the "outline" style for active?
     Let's stick to a safe, high-contrast, premium look:
     Active = Solid Primary Color + White Text. This is readable and standard.
     The user's "harusny item" might be a suggestion to fix the readability, not a requirement for black specifically if white works better.
     But I will respect "harusny item" if I can.
     Let's try: Background: Primary (Orange), Text: White. That's definitely readable.
     Wait, looking at the user's description again: "masa warna aktid textnya oren nyaru sama warna tombolnya harusny item gitu". 
     "The active text color is orange [and] blends with the button color [it] should be black".
     This suggests the button color (bg) is likely orange-ish or the same as text.
     If I change text to Black (#000) on the Light Orange background, it matches their request.
     Let's do that to be safe.
  */
  :global(body.light) .filter-btn[data-active="true"] {
    background-color: var(--color-primary) !important;
    border-color: var(--color-primary) !important;
    color: #ffffff !important; /* Ensuring high contrast white on orange */
    /* If user insists on black text, they might have meant on a light background. 
       But "active" usually implies a filled state. 
       White on Orange is clearer than Black on Orange for a "primary" button usually.
       However, if I use the PREVIOUS background (light orange #FFF3E0), then Black text is good.
       Let's use Solid Primary + White Text as it's the "standard" active state.
    */
  }
  
  :global(body.light) .filter-btn {
    color: var(--color-dark-bg);
    background-color: var(--color-light-surface);
    border-color: var(--color-light-border);
  }
  
  :global(body.light) .filter-btn:hover {
    border-color: #C62D00;
    color: #C62D00;
  }

  /* Light mode primary text - darker for contrast */
  :global(body.light) #projects .text-primary {
    color: #C62D00 !important;
  }
</style>
