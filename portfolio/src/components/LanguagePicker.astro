---
import { languages } from "../i18n/ui";
import {
  getLangFromUrl,
  useTranslatedPath,
  removeLocaleFromUrl,
} from "../i18n/utils";

const lang = getLangFromUrl(Astro.url);
const translatePath = useTranslatedPath(lang);
const currentRoute = removeLocaleFromUrl(Astro.url.pathname);
---

<div class="language-picker relative">
  <button
    id="language-toggle"
    class="flex items-center gap-2 px-3 py-2 rounded-lg bg-white/10 hover:bg-white/20 border border-white/20 hover:border-white/30 transition-all duration-200 text-white"
    aria-label="Select Language"
  >
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"
      ></path>
    </svg>
    <span class="text-sm font-medium">
      {lang === "id" ? "ID" : "EN"}
    </span>
    <svg
      class="w-3 h-3 transition-transform duration-200"
      id="language-chevron"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M19 9l-7 7-7-7"></path>
    </svg>
  </button>

  <div
    id="language-menu"
    class="absolute right-0 top-full mt-2 w-48 bg-dark-surface/95 backdrop-blur-xl rounded-lg shadow-xl border border-dark-border opacity-0 invisible transform scale-95 transition-all duration-200 z-50"
  >
    {
      Object.entries(languages).map(([langCode, label]) => (
        <a
          href={translatePath(currentRoute, langCode)}
          class={`flex items-center gap-3 px-4 py-3 text-sm hover:bg-white/10 transition-colors duration-200 first:rounded-t-lg last:rounded-b-lg ${
            lang === langCode
              ? "bg-primary/20 text-primary font-medium"
              : "text-white/80 hover:text-white"
          }`}
        >
          <div class="flex items-center gap-2">
            {langCode === "id" ? (
              <span class="text-lg">ðŸ‡®ðŸ‡©</span>
            ) : (
              <span class="text-lg">ðŸ‡ºðŸ‡¸</span>
            )}
            <span>{label}</span>
          </div>
          {lang === langCode && (
            <svg
              class="w-4 h-4 ml-auto"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path
                fill-rule="evenodd"
                d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                clip-rule="evenodd"
              />
            </svg>
          )}
        </a>
      ))
    }
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const toggle = document.getElementById("language-toggle");
    const menu = document.getElementById("language-menu");
    const chevron = document.getElementById("language-chevron");

    if (!toggle || !menu || !chevron) return;

    let isOpen = false;

    function openMenu() {
      isOpen = true;
      if (menu) {
        menu.classList.remove("opacity-0", "invisible", "scale-95");
        menu.classList.add("opacity-100", "visible", "scale-100");
      }
      if (chevron) {
        chevron.style.transform = "rotate(180deg)";
      }
    }

    function closeMenu() {
      isOpen = false;
      if (menu) {
        menu.classList.add("opacity-0", "invisible", "scale-95");
        menu.classList.remove("opacity-100", "visible", "scale-100");
      }
      if (chevron) {
        chevron.style.transform = "rotate(0deg)";
      }
    }

    toggle.addEventListener("click", (e) => {
      e.stopPropagation();
      isOpen ? closeMenu() : openMenu();
    });

    // Close menu when clicking outside
    document.addEventListener("click", (e) => {
      if (
        toggle &&
        menu &&
        !toggle.contains(e.target as Node) &&
        !menu.contains(e.target as Node)
      ) {
        closeMenu();
      }
    });

    // Close menu on escape key
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && isOpen) {
        closeMenu();
      }
    });
  });
</script>

<style>
  .language-picker {
    user-select: none;
  }

  .language-picker button:focus {
    outline: 2px solid var(--color-primary);
    outline-offset: 2px;
  }

  .language-picker a:focus {
    outline: 2px solid var(--color-primary);
    outline-offset: -2px;
  }

  /* Light mode adjustments */
  :global(body.light) .language-picker button {
    background-color: rgba(255, 255, 255, 0.9);
    border-color: rgba(0, 0, 0, 0.15);
    color: var(--color-dark-bg);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  :global(body.light) .language-picker button:hover {
    background-color: rgba(255, 255, 255, 1);
    border-color: rgba(0, 0, 0, 0.25);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  :global(body.light) #language-menu {
    background-color: rgba(255, 255, 255, 0.98);
    border-color: rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(20px);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
  }

  :global(body.light) .language-picker a {
    color: rgba(10, 10, 10, 0.85);
  }

  :global(body.light) .language-picker a:hover {
    background-color: rgba(0, 0, 0, 0.08);
    color: var(--color-dark-bg);
  }

  :global(body.light) .language-picker a[class*="bg-primary"] {
    background-color: rgba(59, 130, 246, 0.15) !important;
    color: var(--color-primary) !important;
    font-weight: 600;
  }
</style>
